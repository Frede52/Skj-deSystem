@page "/"
@inject NavigationManager NavigationManager
@using MongoDB.Bson;
@inject HttpClient Http;
@using Core;
@using System.Net.Http
@using System.Net.Http.Json
@using SkjødeSystem.Pages.Apartment;

<head>
    <link href="/css/home.css" rel="stylesheet" />
</head>

<MudContainer Class="mt-16">
    <MudText Typo="Typo.h3" Align="Align.Center" GutterBottom="true">Velkommen User!</MudText>
    <MudText Align="Align.Center">Vælg en plan for at komme i gang!</MudText>

    <MudGrid Class="mt-8">
        <MudItem xs="12" sm="6" md="4">
            <MudCard Elevation="25" Class="rounded-lg pb-4 card-border">
                <MudCardContent Class="d-flex flex-column justify-center align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Apartment" Color="Color.Dark" Size="Size.Large" />
                    <MudText Typo="Typo.body2" Class="mt-2" Style="margin-top: 40px;" Align="Align.Center">Få et overblik over alle boliger!</MudText>
                </MudCardContent>
                <MudCardActions Class="d-flex justify-center">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" Style="width:50%;" Href="/apartments">Gå til boliger</MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="4">
            <MudCard Elevation="25" Class="rounded-lg pb-4 card-border">
                <MudCardContent Class="d-flex flex-column justify-center align-center">
                    <MudIcon Icon="@Icons.Material.Filled.Task" Color="Color.Dark" Size="Size.Large" />
                    <MudText Typo="Typo.body2" Class="mt-2" Style="margin-top: 40px;" Align="Align.Center">Få et overblik over alle opgaver!</MudText>
                </MudCardContent>
                <MudCardActions Class="d-flex justify-center">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" Style="width:50%;" Href="/Viewalltasks">Se alle opgaver</MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="12" md="4">
            <MudCard Elevation="25" Class="rounded-lg pb-4 card-border">
                <MudCardContent Class="d-flex flex-column justify-center align-center">
                    <MudIcon Icon="@Icons.Material.Filled.PersonAdd" Color="Color.Dark" Size="Size.Large" />
                    <MudText Typo="Typo.body2" Class="mt-2" Style="margin-top: 40px;" Align="Align.Center">Tilføj en underentreprenør!</MudText>
                </MudCardContent>
                <MudCardActions Class="d-flex justify-center">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" Style="width:50%;" Href="/addsubcontractor">Tilføj UE</MudButton>
                </MudCardActions>
            </MudCard>
        </MudItem>
    </MudGrid>

    <MudGrid Class="mt-8">
        <MudItem xs="12" sm="6" md="4">
            <MudCard Elevation="25" Class="rounded-lg pb-4 card-border">
                <MudCardContent Class="d-flex flex-column justify-center align-center">
                    <MudText Typo="Typo.h6" Align="Align.Center">Så mange boliger er blevet oprettet:</MudText>
                    <MudText Typo="Typo.h3" Color="Color.Primary" Align="Align.Center">@totalApartmentsCount</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="4">
            <MudCard Elevation="25" Class="rounded-lg pb-4 card-border">
                <MudCardContent Class="d-flex flex-column justify-center align-center">
                    <MudText Typo="Typo.h6" Align="Align.Center">Så mange opgaver mangler at blive fuldført:</MudText>
                    <MudText Typo="Typo.h3" Color="Color.Primary" Align="Align.Center">@pendingTaskCount</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="4">
            <MudCard Elevation="25" Class="rounded-lg pb-4 card-border">
                <MudCardContent Class="d-flex flex-column justify-center align-center">
                    <!-- Tomt kort, ingen indhold -->
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private int pendingTaskCount = 0; // Antallet af opgaver der mangler at blive fuldført

    protected override async System.Threading.Tasks.Task OnInitializedAsync()
    {
        // Hent alle opgaver
        var allTasks = await Http.GetFromJsonAsync<List<TaskItem>>("https://localhost:7210/api/Task/GetAllTasks");

        if (allTasks != null)
        {
            // Filtrér opgaver med status "Pending" på klienten
            pendingTaskCount = allTasks.Count(task => task.Status == "Pending" || task.Status == "Afventer" || task.Status == "Igangværende");
        }

        var apartments = await Http.GetFromJsonAsync<List<Core.Apartment>>("https://localhost:7210/api/Apartment/GetAllApartments");
        totalApartmentsCount = apartments?.Count ?? 0; // Tæller lejlighederne eller sætter til 0, hvis null
    }

    private int totalApartmentsCount;

}
